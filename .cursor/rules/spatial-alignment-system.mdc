---
description: Specification for determining optimal x/y positioning between foreground and background videos through template matching and correlation scoring
globs: **/spatial_alignment.py,**/template_matching.py,**/alignment/*.py,**/video/position.py
alwaysApply: false
---


# spatial-alignment-system

The spatial alignment system determines the optimal position to overlay foreground video onto background video through template matching and correlation analysis.

Core Components:

## Template Matching Engine
Importance Score: 95
- Extracts representative frames from temporal midpoint of both videos
- Converts frames to grayscale for robust matching
- Uses normalized cross-correlation coefficient scoring
- Slides foreground frame across background to find optimal position
- Returns x,y coordinates and confidence score

## Position Detection Pipeline
Importance Score: 90
- Frame selection from video midpoint to avoid titles/credits
- Grayscale conversion for alignment robustness
- Template matching with TM_CCOEFF_NORMED method
- Position determination from highest correlation score
- Automatic scaling if foreground exceeds background size

## Correlation Analysis
Importance Score: 85
- Normalized cross-correlation scoring between frames
- Confidence calculation based on correlation coefficient
- Threshold validation of match quality
- Scale factor determination when size mismatch detected
- Returns position tuple with confidence metric

## Border Mode Handler 
Importance Score: 75
- Special alignment mode focusing on visible background edges
- Border thickness parameter for match area
- Edge-based correlation scoring
- Position refinement based on border matching
- Returns adjusted position coordinates

The system prioritizes finding globally optimal positioning while handling resolution mismatches and different aspect ratios between videos. Template matching enables precise alignment even with cropped or partial content overlap.

$END$