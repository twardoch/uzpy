---
description: Technical documentation for video frame template matching and spatial alignment algorithms
globs: src/vidkompy/spatial/*.py,src/vidkompy/alignment/*.py,src/vidkompy/matcher/*.py
alwaysApply: false
---


# spatial-alignment-system

The spatial alignment system determines optimal positioning of the foreground video within the background video frame using a multi-stage template matching approach.

## Core Components

### Template Matcher (Importance: 95)
- Implements normalized cross-correlation scoring between frame pairs
- Uses grayscale conversion for robust pattern matching
- Calculates correlation scores across all possible x/y offset positions
- Returns optimal position with highest correlation coefficient

### Frame Position Detector (Importance: 90)
1. Frame Selection Logic
- Extracts representative frames from video temporal midpoint
- Avoids edge frames that may contain titles/credits
- Validates frame content meets minimum quality threshold

2. Scale Detection
- Detects if foreground exceeds background dimensions
- Calculates required scale factor while preserving aspect ratio
- Applies scaling transformations as needed

3. Position Refinement
- Fine-tunes initial match position using edge detection
- Validates position against frame boundaries
- Applies spatial constraints to keep foreground fully visible

### Match Validation (Importance: 85)
- Confidence scoring based on correlation coefficient normalization
- Minimum threshold validation for match acceptance
- Edge case handling for partial matches and low confidence results

Relevant File Paths:
```
src/vidkompy/spatial/
  ├── matcher.py       # Template matching core
  ├── detector.py      # Position detection logic  
  └── validator.py     # Match validation system
```

$END$